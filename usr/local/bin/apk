#!/bin/sh

# Define the log file
LOGFILE="/var/log/apk.log"

# Check if there are arguments
if [ "$#" -eq 0 ]; then
    echo "No arguments provided. Exiting."
    exit 1
fi

# Capture the entire command line
COMMAND_LINE="$@"

# Check if the command line contains 'add', 'del', or 'upgrade'
if echo "$COMMAND_LINE" | grep -E '\b(add|del|upgrade)\b' > /dev/null; then
    # Log the command and its arguments
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] doas apk $COMMAND_LINE" >> "$LOGFILE"

    # Run the apk command, prepend each line with a timestamp, and log to the file
    {
        /sbin/apk $COMMAND_LINE | awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'
    } | tee -a "$LOGFILE"
else
    # For other apk commands, just run them without logging
    /sbin/apk $COMMAND_LINE
fi
